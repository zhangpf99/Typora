# 证券端开户

## LS\_银行账户\_存管账户证券发起开户

### 1. [AS\_用户公用\_系统状态和用户权限检查]

### 2.[AS\_存管公用\_储蓄银行参数获取]

- 根据bank_no查询bankarg和bankexcharg表数据，获取表字段值，包括@bank_model_no字段

- 当@bank_model_no不为0时，根据@bank_model_no匹配bankinterface表，获取表字段

- AF\_存管公用\_转账参数子串值获取

- > AF\_存管公用\_转账参数子串值获取:
  >
  > 根据business_flag获取@pos值，获取配置位对应值是1或0,如果开启则置检查密码为1

- LF\_存管同步\_存管账户证券发起开户

- > 1. 根据输入的资产账户获取资产账户节点信息和asset_prop
  >
  > 2. 检查点：（asset_prop=0，bank_type=2）或（asset_prop=B，bank_type=5）或（asset_prop=7，bank_type=4）,不满足就报错
  > 3. 如果输入的账户姓名为空，则获取client_name作为账户姓名holder_name_long

- LF\_银行账户\_存管账户\_证券发起存管处理

- >1. 获取资产账户节点信息
  >2. 获取客户的@organ_flag
  >3. AS\_银行账户\_资产账户信息获取

- AS\_银行账户\_资产账户信息获取

- > 1. 获取资产账户信息，包括客户限制@restriction等字段
  > 2. 检查fund_status状态，某些状态会提示报错
  > 3. \[AF\_存管公用\_客户结算银行获取]\[bank_no=@square_bank_no]
  >
  > > AF\_存管公用\_客户结算银行获取:
  > >
  > > 如果money_type为空，则money_type置为‘0’
  > >
  > > 根据fund_account和money_type匹配，取fund表内的@bank_no和@square_flag字段
  > >
  > > （square_flag:0-本地客户、1-银证通客户、2-三方存管）
  > >
  > > 如果@bank_no为空，则置为0，如果@square_flag为空格，则@square_flag置为0-本地客户
  >
  > 4. AF\_存管公用\_客户结算银行获取 出参的bank_no作为@square_bank_no，square_flag出参作为@square_flag
  > 5. 如果asset_prop为融资融券客户，@busin_type = '2'
  > 6. 如果asset_prop为'B',@busin_type = '3'
  > 7. 如果@square_bank_no不为0且@square_flag为2，则@busin_type = '1'
  > 8. 其他情况为‘0’

判断@business_flag和@restriction，如果满足某些条件，会检查，如：

>   if( (CNST_BUSIFLAG_SMSCODE_BKCTSACCO_OPEN == @business_flag || CNST_BUSIFLAG_SMSCODE_BKCTSACCO_OPENACTIVATION == @business_flag) && hs_strstr(@restriction, "S") > 0)
>   {
>     	\[函数报错返回\]\[ERR\_ASSET\_FUNDACCOUNT_RESTRICTION_EXCHACCT_REG]\[资产账户限制,禁止存管签约确认]\[@fund_account, @bank_no, @bank_account, @business_flag]
>   }

如果client_name为空，client_name取client表的客户姓名

如果

